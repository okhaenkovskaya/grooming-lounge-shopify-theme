{% assign product_found = false %}
{% assign skip = false %}
{% assign collection_group = products | map: 'id' %}
{% assign collection_group_thumb = collection_group | append : 'thumb' %}
{% assign collection_group_mobile = collection_group | append : 'mobile' %}

{%- if template contains 'collection' -%}
    {% assign oos_collection = collections[ oos_collection_handle ] %}
    {% assign col_suffix = collection.url | slice: -1, 4 %}
    {%- if col_suffix != '-oos' -%}
        {% assign current_not_oos_collection = true %}
    {%- endif -%}
{%- endif -%}

{% if template contains 'collection' or template contains 'page' %}
  {% assign matrixType = 'collection-matrix' %}
{% elsif template contains 'search' %}
  {% assign matrixType = 'search-matrix' %}
{% endif %}

{% assign forLimit = limit %}

{%- unless template contains 'page' -%}
<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "ItemList",
    "itemListElement": [
      {% for product in products limit: limit %}
        {
          "@type": "ListItem",
          "position": "{{ forloop.index | json }}",
          "url": "{{ shop.url }}{{ product.url }}",
          "name": "{{ product.title | escape }}"
        } {%- unless forloop.last -%},{%- endunless -%}
      {% endfor %}
    ]
  }
</script>
{%- endunless -%}


{% for product in products limit: limit %}
  {% if product.id == skip_product.id  %}
    {% assign forLimit = limit | plus: 1 %}
  {% endif %}
{% endfor %}

<div itemtype="http://schema.org/ItemList" class="product-list {{ matrixType }} clearfix equal-columns--clear equal-columns--outside-trim">
  {% for product in products limit: limit %}
    {% include 'product-thumbnail', sidebar: sidebar %}
  {% endfor %}
  {% if template contains 'collection' %}
    {% if settings.pagination_type == 'load_more' or settings.pagination_type == 'infinite_scroll' %}
      {% if paginate.next.url %}
        <span class="js-load-more load-more">
          <a href="{{ paginate.next.url }}" data-no-instant class="load-more__btn action_button continue-button">
            {{ 'collections.general.load_more' | t }}
          </a>
        </span>

      {% comment %}
          If the main collection is out of products, we check if the out of stock
          collection exists and contains any product. If that's the case, we
          start pulling it in.
      {% endcomment %}
      {%- elsif oos_collection and oos_collection.products.size > 0 and current_not_oos_collection -%}
          <span class="js-load-more load-more">
            <a href="{{ oos_collection.url }}" data-no-instant class="load-more__btn action_button continue-button">
              {{ 'collections.general.load_more' | t }}
            </a>
          </span>
      {% endif %}
    {% endif %}
  {% elsif template contains 'search' %}
    {% if settings.search_pagination_type == 'load_more' or settings.search_pagination_type == 'infinite_scroll' %}
      {% if paginate.next.url %}
        <span class="js-load-more load-more">
          <a href="{{ paginate.next.url }}" data-no-instant class="load-more__btn action_button continue-button">
            {% if template contains 'collection' %}
              {{ 'collections.general.load_more' | t }}
            {% elsif template contains 'search' %}
              {{ 'general.search.load_more' | t }}
            {% endif %}
          </a>
        </span>
      {% endif %}
    {% endif %}
  {% endif %}
</div>
<div class="load-more__icon"></div>
